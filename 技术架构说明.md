## 医院患者预约挂号系统 - 技术架构说明

文档版本：v1.0  
编制日期：2025-10-31  
依据文档：`需求说明书.md`、`需求.txt`

---

## 1. 总体架构
- 架构风格：前后端分离，RESTful API
- 三层结构：前端 Web（React）→ 后端服务（Java 21）→ 数据库（MySQL 8.0）
- 关键横切：认证鉴权（JWT + RBAC）、日志与审计、异常处理、配置管理、数据迁移

逻辑视图：
- 表现层：React 单页应用（SPA），路由按角色划分（患者/医生/管理员）
- 业务层：面向领域的 Service，封装会诊、预约、退号、在岗管理等核心逻辑
- 数据层：JPA/Repository 访问 MySQL；通过迁移工具（Flyway）版本化 DDL/DML

---

## 2. 技术选型
- 前端：React 18 + JavaScript、React Router v6、Redux Toolkit（全局状态）、React Query（服务端状态）、Axios（HTTP）、Ant Design（UI，可替换）
- 后端：Java 21、Spring Boot 3.x、Spring Web、Spring Security + JWT、Spring Data JPA（Hibernate）、MapStruct、Lombok、Bean Validation（Jakarta Validation）、Flyway、Logback
- 数据库：MySQL 8.0，字符集 utf8mb4，事务引擎 InnoDB
- 测试：Jest + React Testing Library（前端）；JUnit 5 + Spring Boot Test + Testcontainers（后端）

说明：以上为推荐组合，若已有团队规范可等价替换。

---

## 3. 前端架构（React + JavaScript）
### 3.1 目录结构（建议）
```
frontend/
  src/
    app/                # 应用入口与全局配置
    routes/             # 路由配置（按角色分区：patient/doctor/admin）
    pages/              # 页面组件
      Login/            # 登录页
      Register/         # 注册页
      Patient/          # 患者端页面（Dashboard、Appointment、MyAppointments、MyVisits、Profile）
      Doctor/           # 医生端页面（Dashboard、Appointments、Schedules、Profile）
      Admin/            # 管理员端页面（Dashboard、Departments、Doctors、Statistics、Rankings、Records）
    components/         # 复用组件（表格、表单、选择器、头像上传等）
    features/           # 领域模块（appointments、departments、reviews、schedules 等，可选）
    store/              # Redux Toolkit（slices、middlewares）
    services/           # Axios 封装、API SDK（typed request/response）
    hooks/              # 自定义 hooks（useAuth、usePagination 等）
    utils/              # 工具方法（日期、校验、格式化）
    assets/             # 静态资源
    index.jsx           # React 入口
  package.json
```

### 3.2 路由与访问控制
- 基于 React Router v6 配置三大入口：`/patient`、`/doctor`、`/admin`
- 使用路由守卫（高阶组件/自定义 Hook）按角色校验 JWT 中的 `role`

### 3.3 状态管理
- 全局应用态：登录态、用户信息、主题、全局消息 → Redux Toolkit
- 服务端数据：列表/详情、分页、缓存、重试 → React Query

### 3.4 HTTP 与错误处理
- Axios 实例化：注入 `Authorization: Bearer <token>`；统一 401/403 处理与刷新/登出
- 错误呈现：消息条/对话框，表单级错误高亮

### 3.5 UI 与表单
- Ant Design 表单（患者注册、预约、会诊输入）、表格（预约列表、就诊记录、统计）
- 统一表单校验（手机号 11 位；必填项；时间范围 1-7 天）

### 3.6 配置与环境
- `.env.development`/`.env.production` 管理 `VITE_API_BASE_URL` 或 `REACT_APP_API_BASE_URL`

### 3.7 基础代码片段
```javascript
// services/http.js
import axios from 'axios';

const http = axios.create({ baseURL: process.env.REACT_APP_API_BASE_URL });

http.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) config.headers.Authorization = `Bearer ${token}`;
  return config;
});

http.interceptors.response.use(
  (res) => res,
  (err) => {
    if (err.response?.status === 401) {
      localStorage.removeItem('token');
      window.location.replace('/login');
    }
    return Promise.reject(err);
  }
);

export default http;
```

---

## 4. 后端架构（Java 21）
### 4.1 目录结构（建议）
```
backend/
  src/main/java/
    com/hospital/
      HospitalApplication.java  # 应用入口
      controller/               # REST API 控制器
      service/                  # 业务逻辑层
      repository/               # 数据访问层
      entity/                   # 实体类
      dto/                      # 数据传输对象
        request/                # 请求DTO
        response/               # 响应DTO
      mapper/                   # 实体与DTO映射（MapStruct）
      config/                   # 配置类
      security/                 # 安全相关（JWT等）
      exception/                # 异常处理
      enums/                    # 枚举类
      util/                     # 工具类
  src/main/resources/
    application.properties
    db/migration/               # Flyway 迁移脚本
  pom.xml
```

### 4.2 分层设计
- `controller`：REST API 入口，DTO 收发、异常映射
- `service`：领域服务（预约、会诊、退号、在岗）与事务边界
- `repository`：Spring Data JPA，专注数据访问
- `entity`：实体与聚合根；`dto`：输入输出对象；`mapper`：实体-DTO 映射（MapStruct）

### 4.3 安全与认证
- 登录成功颁发 JWT，`sub`=用户 ID，`role`∈{PATIENT, DOCTOR, ADMIN}
- Spring Security 过滤链：`/auth/**` 放行，其他按角色授权
- 医生登录需额外校验码 `Doctor`

### 4.4 校验与异常
- Jakarta Validation：注解校验字段，统一异常处理 `@ControllerAdvice`
- 错误响应结构：`{ code, message, traceId, details? }`

### 4.5 配置与运行
```properties
# application.properties
spring.datasource.url=jdbc:mysql://localhost:3306/hospital?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&characterEncoding=utf8mb4
spring.datasource.username=root
spring.datasource.password=jyh20050820
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=true
spring.flyway.enabled=true
logging.level.root=INFO
```

### 4.6 典型接口示例
```http
POST /auth/patient/login
{ "account": "u1", "password": "***" }
-> { "token": "<jwt>", "role": "PATIENT" }

POST /appointments
{ "doctorId":1, "departmentId":2, "visitAt":"2025-11-01T09:00:00Z", "illnessDesc":"..." }
-> { "id":101, "status":"PENDING" }

POST /consultations/101/complete
{ "advice":"多喝水", "medsServices":[{"itemId":5, "qty":1}] }
-> 200 OK
```

---

## 5. 数据库设计（MySQL 8.0）
### 5.1 主要表（节选，字段可按实现细化）
- `patients(id, account, password_hash, real_name, phone, age, height, weight, avatar_url, created_at)`
- `doctors(id, account, password_hash, name, status, avatar_url, created_at)`
- `admins(id, account, password_hash, created_at)`
- `departments(id, name, description, enabled)`
- `doctor_departments(id, doctor_id, department_id)`
- `schedules(id, doctor_id, start_at, end_at, status)`
- `appointments(id, patient_id, doctor_id, department_id, visit_at, status, illness_desc, created_at)`
- `visits(id, appointment_id, fee, doctor_advice, created_at)`
- `items(id, name, price, type)`
- `visit_items(id, visit_id, item_id, qty, amount)`
- `reviews(id, patient_id, doctor_id, department_id, score, created_at)`
- `reminders(id, appointment_id, trigger_at, channel)`

### 5.2 DDL 示例（节选）
```sql
CREATE TABLE departments (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(64) NOT NULL UNIQUE,
  description VARCHAR(255),
  enabled TINYINT NOT NULL DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE appointments (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  patient_id BIGINT NOT NULL,
  doctor_id BIGINT NOT NULL,
  department_id BIGINT NOT NULL,
  visit_at DATETIME NOT NULL,
  status ENUM('PENDING','VISITED','CANCELLED') NOT NULL,
  illness_desc VARCHAR(500),
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_doctor_visit (doctor_id, visit_at),
  INDEX idx_patient_created (patient_id, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 5.3 约束与规则
- 预约时间仅允许未来 1-7 天；医生不在岗时段不可预约
- 删除科室需同步影响医生擅长科室关联
- 删除医生为物理删除，历史就诊记录保留外键为 `SET NULL` 或保留冗余快照字段

---

## 6. 接口规范
- 协议：HTTPS（本地可 HTTP），JSON 编解码，UTC 时间使用 ISO8601
- 版本：`/api/v1/*`
- 鉴权：`Authorization: Bearer <jwt>`；管理员/医生无注册接口
- 分页：`page`、`size`、`sort=field,asc|desc`
- 错误码：业务 `code`（如 `APPT_OUT_OF_RANGE`），HTTP 状态与之对应

### 6.1 主要端点（与需求对应，精炼版）
- 认证：`POST /auth/patient/register`，`POST /auth/patient/login`，`POST /auth/doctor/login`，`POST /auth/admin/login`，`POST /auth/logout`
- 患者：
  - `GET /departments`，`GET /doctors?departmentId=`，`GET /schedules?doctorId=&date=`
  - `POST /appointments`，`PUT /appointments/{id}/reschedule`，`DELETE /appointments/{id}`
  - `GET /appointments/mine`，`GET /appointments/{id}/reminder`
  - `GET /visits/mine`，`GET /visits/{id}`
  - `POST /reviews/doctor`，`POST /reviews/department`
  - `GET/PUT /patients/me`（头像上传）
- 医生：
  - `GET/PUT /doctors/me`，`PUT /doctors/me/status`
  - `GET /appointments/doctor/mine`，`GET /appointments/{id}`
  - `POST /consultations/{appointmentId}/complete`
  - `PUT /schedules/me`
- 管理端：
  - `GET/POST/PUT/DELETE /departments`
  - `GET/POST/PUT/DELETE /doctors`
  - `GET /stats/overview`，`GET /stats/daily-appointments`，`GET /stats/daily-visits`
  - `GET /rankings/departments`，`GET /rankings/doctors`
  - `GET /admin/records`

---

## 7. 权限模型（RBAC）
| 资源 | PATIENT | DOCTOR | ADMIN |
| --- | --- | --- | --- |
| /appointments（创建/改签/退号） | 读/写自身 | 读关联 | 读 |
| /consultations/complete | - | 写 | - |
| /doctors/me、/schedules/me | - | 读/写自身 | - |
| /departments | 读 | 读 | 读/写 |
| /doctors（管理） | - | - | 读/写/删 |
| /stats, /rankings, /admin/records | - | - | 读 |

---

## 8. 关键业务流程（时序概要）
- 患者预约：`Patient` → 查询 → 选医生与时段 → 提交预约（校验在岗与时间范围）→ 记录 `PENDING`
- 医生会诊完成：`Doctor` → 查看预约 → 会诊 → 填写建议/服务 → 预约转 `VISITED` → 生成 `Visit`
- 患者退号：`Patient` → 我的预约 → 退号 → 预约转 `CANCELLED`

---

## 9. 部署与运行（本地）
### 9.1 前端
```bash
npm install
npm start
# 环境变量：REACT_APP_API_BASE_URL=http://localhost:8080/api/v1
```

### 9.2 后端
```bash
# JDK 21 & Maven
mvn clean package
java -jar target/hospital-app.jar
```

### 9.3 数据库
- MySQL 8.0，本地 `root/jyh20050820`
- 启用 Flyway，在 `db/migration` 下维护 SQL 脚本（初始化儿科/口腔科/内科/外科）

---

## 10. 日志、审计与监控（本地）
- 统一 TraceId（MDC）贯穿请求链路；敏感信息脱敏
- 关键事件（登录、预约、退号、会诊完成）写入审计日志

---

## 11. 代码与提交规范
- 命名：可读、无缩写；前端采用函数式组件与 Hooks
- 格式化：Prettier（前端）、Spotless 或 EditorConfig（后端）
- 提交信息：`feat: `、`fix: `、`docs: `、`chore: `、`test: `

---

## 12. 测试策略
- 单元：领域服务与工具方法覆盖核心分支
- 集成：接口层与数据库交互（Testcontainers）
- 端到端：关键路径（注册/登录/预约/会诊/退号）

---

## 13. 风险与边界
- 高并发同一时段预约冲突：需加行级锁或唯一约束 + 重试
- 医生在岗变更对既有预约的影响：制定规则（仅影响未来时段）
- 个人隐私与日志：严禁明文输出敏感字段

---

## 14. 里程碑（与需求一致）
- M1：认证与角色切分、科室初始化、患者查询与预约
- M2：医生在岗/会诊流程、就诊记录与提醒
- M3：管理员管理、统计与排行
- M4：评价体系、非功能与验收

---

附：本说明书与 `需求说明书.md` 一致，若有冲突以评审结论为准。


